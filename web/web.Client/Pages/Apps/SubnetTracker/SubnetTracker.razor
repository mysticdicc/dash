@using System.Collections
@using System.Net
@using System.Text.RegularExpressions
@using System.Threading.Tasks
@using NetTools
@using DashLib.Interfaces
@using web.Client.Services
@using System.Text.Json

@inject ISubnetsAPI SubnetService
@inject IJSRuntime JSRuntime

@page "/subtrackr/home"

<PageTitle>subnet trackr</PageTitle>

<InputFile OnChange="@OnClickUpload" id="upload" style="overflow: hidden; width: 0; height: 0;" accept="*.png" />

<article>
    <header>
        <button onclick="@OnClickNewSubnet">
            <span class="material-icons">add</span>
        </button>
        @if (_advancedViewEnabled)
        {
            <button id="green" onclick="@OnClickAdvancedToggle">
                <span class="material-icons">visibility</span>
            </button>
        }
        else
        {
            <button id="red" onclick="@OnClickAdvancedToggle">
                <span class="material-icons">visibility</span>
            </button>
        }
        <button @onclick="@OnInitializedAsync">
            <span class="material-icons">refresh</span>
        </button>
        <span>
            <button @onclick="@OnClickUploadButton">
                <span title="Upload subnet export" class="material-icons">upload</span>
            </button>
            <button @onclick="@OnClickSave">
                <span title="Download subnet export" class="material-icons">download</span>
            </button>
        </span>
    </header>
    <content class="subnet_layout">
        <table>
            <tr>
                <th>
                    Subnet Address
                </th>
                <th>
                    Start Address
                </th>
                <th>
                    End Address
                </th>
                <th>
                    IP Search
                </th>
                <th/>
            </tr>
            @foreach (Subnet subnet in SubnetList)
            {
                <SubnetCard Subnet="subnet" OnEditIp="@OnClickEditIP" OnEditSubnet="@OnClickEditSubnet" @bind-AdvancedViewEnabled="@_advancedViewEnabled" OnDeleteClicked="@OnDeleteClicked" OnDeleteIp="@OnDeleteClicked" />
            }
        </table>
    </content>
</article>

@if (null != _editingSubnet)
{
    <SubnetEditor @bind-EditorVisible="@_subnetEditorVisible" Subnet="_editingSubnet" @bind-IsNewSubnet="@_isNewSubnet" SubnetSaved="@OnSubnetSaved"/>
}

@if (null != _editingIP)
{
    <IpEditor @bind-EditorVisible="@_ipEditorVisible" IpAddress="_editingIP" />
}
)

@code {
    List<Subnet> SubnetList = [];
    private bool _subnetEditorVisible = false;
    private bool _ipEditorVisible = false;
    private bool _isNewSubnet = false;
    private bool _advancedViewEnabled = true;

    private Subnet? _editingSubnet = null;
    private IP? _editingIP = null;

    async protected override Task OnInitializedAsync()
    {
        SubnetList = await SubnetService.GetAllAsync();
        await base.OnInitializedAsync();
        StateHasChanged();
    }

    private void OnClickEditSubnet(Subnet subnet)
    {
        _editingSubnet = subnet;
        _isNewSubnet = false;
        _subnetEditorVisible = true;
    }

    private void OnClickEditIP(IP ip)
    {
        _editingIP = ip;
        _ipEditorVisible = true;
    }

    private void OnClickNewSubnet()
    {
        _isNewSubnet = true;
        _editingSubnet = new Subnet("192.168.0.1/24");
        _subnetEditorVisible = true;
        StateHasChanged();
    }

    private void OnClickAdvancedToggle()
    {
        _advancedViewEnabled = !_advancedViewEnabled;
    }

    private async void OnSubnetSaved(Subnet subnet)
    {
        await Task.Delay(100);
        await OnInitializedAsync();
    }

    private async void OnDeleteClicked(bool clicked)
    {
        if (clicked)
        {
            await Task.Delay(100);
            await OnInitializedAsync();
        }
    }

    async void OnClickSave()
    {
        if (null != SubnetList && SubnetList.Count > 0)
        {
            await File.SaveAs(JSRuntime, "subnets.json", JsonSerializer.Serialize(SubnetList, AllSettings.JsonOptions));
        }
    }

    async void OnClickUpload(InputFileChangeEventArgs eventArgs)
    {
        var str = await File.InputFileToString(eventArgs);
        var items = JsonSerializer.Deserialize<List<Subnet>>(str, AllSettings.JsonOptions);

        if (null != items && items.Count > 0)
        {
            await SubnetService.ReplaceAllSubnetsAsync(items);
            await OnInitializedAsync();
        }
    }

    async void OnClickUploadButton()
    {
        await JSRuntime.InvokeVoidAsync("clickUpload");
    }
}