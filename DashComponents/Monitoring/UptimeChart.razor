@if (Visible)
{
    <div>
        <header>
            <button id="expand" @onclick="@OnClickExpand">
                <span class="material-icons">expand</span>
            </button>
        </header>
        <article>
            <div id="uptime_chart">
                <div id="left">
                    @if (_chartsReady)
                    {
                        <ApexChart TItem="UptimePoint" Options="RadialBarOptions" @ref="radialChart">
                            <ApexPointSeries TItem="UptimePoint"
                                             Items="UptimePoints"
                                             SeriesType="SeriesType.RadialBar"
                                             YValue="point => point.Percentage"
                                             XValue="point => point.DeviceLabel" />
                        </ApexChart>
                    }
                </div>
                <div>
                    @if (_chartsReady)
                    {
                        <ApexChart TItem="HeatMapPoint"
                                   Title="Device Status Over Time"
                                   Options="HeatMapOptions"
                                   @ref="heatMapChart">
                            <ApexPointSeries TItem="HeatMapPoint"
                                             Items="OnlineHeatMapPoints"
                                             Name="Online"
                                             SeriesType="SeriesType.Heatmap"
                                             XValue="point => point.TimeLabel"
                                             YValue="point => point.Count"
                                             OrderBy="e => e.X" />
                            <ApexPointSeries TItem="HeatMapPoint"
                                             Items="OfflineHeatMapPoints"
                                             Name="Offline"
                                             SeriesType="SeriesType.Heatmap"
                                             XValue="point => point.TimeLabel"
                                             YValue="point => point.Count"
                                             OrderBy="e => e.X" />
                        </ApexChart>
                    }
                </div>
            </div>
        </article>
    </div>
}

@code {
    [Parameter] public required List<IP>? IPAddresses { get; set; }
    [Parameter] public required bool Visible { get; set; }
    [Parameter] public required EventCallback<bool> VisibleChanged { get; set; }
    [Parameter] public required EventCallback<string> ExpandChanged { get; set; }

    private static List<string> _palette = new() { "#008FFB", "#00E396", "#FEB019", "#FF4560", "#775DD0", "#3F51B5", "#546E7A", "#D4526E", "#8D5B4C", "#F86624" };

    public bool _expanded = false;
    public bool _chartsReady = false;   
    private ApexChart<UptimePoint>? radialChart;
    private ApexChart<HeatMapPoint>? heatMapChart;

    public class UptimePoint
    {
        public decimal Percentage { get; set; }
        public string DeviceLabel { get; set; } = string.Empty;
    }

    public class HeatMapPoint
    {
        public string TimeLabel { get; set; } = string.Empty;
        public int Count { get; set; }
    }

    List<UptimePoint> UptimePoints = new();
    List<HeatMapPoint> OnlineHeatMapPoints = new();
    List<HeatMapPoint> OfflineHeatMapPoints = new();

    ApexChartOptions<UptimePoint> RadialBarOptions = new()
    {
        Chart = new Chart
        {
            Width = "100%",
            Height = "100%",
            Type = ChartType.RadialBar
        },
        PlotOptions = new PlotOptions
        {
            RadialBar = new PlotOptionsRadialBar
            {
                DataLabels = new RadialBarDataLabels
                {
                    Name = new RadialBarDataLabelsName
                    {
                        Show = true
                    },
                    Value = new RadialBarDataLabelsValue
                    {
                        Show = true
                    },
                    Total = new RadialBarDataLabelsTotal
                    {
                        Show = true,
                        Label = "Total Uptime",
                        Formatter = "function(w) { return (w.globals.series.reduce((a, b) => a + b, 0) / w.globals.series.length).toFixed(2) + '%'; }"
                    }
                }
            }
        },
        Colors = _palette,
        Stroke = new Stroke
        {
            LineCap = LineCap.Round
        }
    };

    ApexChartOptions<HeatMapPoint> HeatMapOptions = new()
    {
        Chart = new Chart
        {
            Width = "100%",
            Height = "100%",
            Type = ChartType.Heatmap
        },
        Xaxis = new XAxis
        {
            Type = XAxisType.Category
        },
        DataLabels = new DataLabels
        {
            Enabled = true
        },
        PlotOptions = new PlotOptions
        {
            Heatmap = new PlotOptionsHeatmap
            {
                Radius = 0,
                EnableShades = true
            }
        },
        Colors = new List<string>() { "#AFE1AF", "#D22B2B" }
    };

    protected override async Task OnParametersSetAsync()
    {
        _chartsReady = false;
        UptimePoints.Clear();
        OnlineHeatMapPoints.Clear();
        OfflineHeatMapPoints.Clear();

        if (IPAddresses == null)
            return;

        foreach (var ip in IPAddresses.Where(ip => (ip.IsMonitoredTCP || ip.IsMonitoredICMP) && ip.Address != null))
        {
            var states = ip.MonitorStateList?.Where(ms => ms != null && ms.PingState != null).ToList();
            if (states == null || states.Count == 0)
                continue;

            int total = states.Count;
            int up = states.Count(ms => ms.PingState!.Response);
            decimal percent = total > 0 ? Math.Round((decimal)up / total * 100, 1) : 0;

            string label = IP.ConvertToString(ip.Address);
            if (!string.IsNullOrWhiteSpace(ip.Hostname))
                label += $" ({ip.Hostname})";

            UptimePoints.Add(new UptimePoint
            {
                Percentage = percent,
                DeviceLabel = label
            });
        }

        var allStates = IPAddresses
            .Where(ip => ip.MonitorStateList != null)
            .SelectMany(ip => ip.MonitorStateList!)
            .Where(ms => ms.PingState != null)
            .ToList();

        var grouped = allStates
            .GroupBy(ms => ms.SubmitTime)
            .OrderBy(g => g.Key);

        foreach (var group in grouped)
        {
            string timeLabel = group.Key.ToString("dd/MM HH:mm");
            
            OnlineHeatMapPoints.Add(new HeatMapPoint
            {
                TimeLabel = timeLabel,
                Count = group.Count(ms => ms.PingState!.Response)
            });
            
            OfflineHeatMapPoints.Add(new HeatMapPoint
            {
                TimeLabel = timeLabel,
                Count = group.Count(ms => !ms.PingState!.Response)
            });
        }

        await Task.Delay(500);
        _chartsReady = true;
    }

    private async Task OnClickExpand()
    {
        if (_expanded)
        {
            await ExpandChanged.InvokeAsync("undo");
            _expanded = false;
        }
        else
        {
            await ExpandChanged.InvokeAsync("uptimechart");
            _expanded = true;
        }
    }
}
